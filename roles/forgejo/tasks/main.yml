---
- name: "Generate Forgejo Docker Compose file"
  include_role:
    name: utils
    tasks_from: install_docker_compose_raw.yml
  vars:
    container_name: forgejo
    host: nighthawk
    docker_compose_content: |
      networks:
        proxy:
          external: true
        forgejo-internal:
          external: false

      volumes:
        docker_certs:

      services:
        docker-in-docker:
          image: code.forgejo.org/oci/docker:dind
          hostname: docker
          privileged: true
          environment:
            DOCKER_TLS_CERTDIR: /certs
            DOCKER_HOST: docker-in-docker
          restart: unless-stopped
          volumes:
            - docker_certs:/certs
            - /etc/ssl/certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
          command: ["--insecure-registry={{ forgejo_domain }}"]
          networks:
            - forgejo-internal

        forgejo:
          image: codeberg.org/forgejo/forgejo:13
          container_name: forgejo
          command: >-
            bash -c "
            /usr/bin/s6-svscan /etc/s6 &
            sleep 10 ;
            su -c 'forgejo forgejo-cli actions register --keep-labels --secret {{ forgejo_shared_secret1 }}' git ;
            su -c 'forgejo forgejo-cli actions register --keep-labels --secret {{ forgejo_shared_secret2 }}' git ;
            su -c 'forgejo admin user create --admin --username root --password {{ forgejo_root_password }} --email root@{{ forgejo_domain }}' git ;
            sleep infinity
            "
          environment:
            - USER_UID=1000
            - USER_GID=1000
            - FORGEJO__database__DB_TYPE=mysql
            - FORGEJO__database__HOST=db:3306
            - FORGEJO__database__NAME=forgejo
            - FORGEJO__database__USER={{ forgejo_db_user }}
            - FORGEJO__database__PASSWD={{ forgejo_db_password }}
            - FORGEJO__server__DOMAIN={{ forgejo_domain }}
          networks:
            - proxy
            - forgejo-internal
          volumes:
            - "/docker/forgejo/data:/data"
            - "/etc/timezone:/etc/timezone:ro"
            - "/etc/localtime:/etc/localtime:ro"
          ports:
            - "127.0.0.1:222:22"
          restart: unless-stopped
          depends_on:
            - db
          labels:
            - "traefik.enable=true"
            - "traefik.http.routers.forgejo.rule=Host(`{{ forgejo_domain }}`)"
            - "traefik.http.routers.forgejo.entrypoints=websecure"
            - "traefik.http.routers.forgejo.tls=true"
            - "traefik.http.services.forgejo.loadbalancer.server.port=3000"

        db:
          image: mysql:8
          container_name: forgejo-db
          restart: unless-stopped
          environment:
            - MYSQL_ROOT_PASSWORD={{ forgejo_db_password }}
            - MYSQL_USER={{ forgejo_db_user }}
            - MYSQL_PASSWORD={{ forgejo_db_password }}
            - MYSQL_DATABASE=forgejo
          volumes:
            - "/docker/forgejo/mysql:/var/lib/mysql"
          networks:
            - forgejo-internal

        runner-register:
          image: code.forgejo.org/forgejo/runner:12.5.2
          links:
            - docker-in-docker
            - forgejo
          environment:
            DOCKER_HOST: tcp://docker-in-docker:2376
          volumes:
            - /docker/forgejo/runner-data:/data
          user: 0:0
          command: >-
            bash -ec '
            while : ; do
              cd /data
              forgejo-runner create-runner-file --connect --instance http://forgejo:3000 --name nighthawk-runner --secret {{ forgejo_shared_secret1 }} && break ;
              sleep 1 ;
            done ;
            sed -i -e "s|\"labels\": null|\"labels\": [\"x86-64:docker://code.forgejo.org/oci/node:20-bookworm\"]|" .runner ;
            sed -i -e "s|\"labels\": null|\"labels\": [\"x86-64:docker://code.forgejo.org/oci/node:20-bookworm\"]|" .runner ;
            forgejo-runner generate-config > config.yml ;
            sed -i -e "s|  level: info|  level: debug|" config.yml ;
            sed -i -e "s|network: .*|network: host|" config.yml ;
            sed -i -e "s|docker_host: .*|docker_host: automount|" config.yml ;
            sed -i -e "s|^  envs:$$|  envs:\n    DOCKER_HOST: tcp://docker:2376\n    DOCKER_TLS_VERIFY: 1\n    DOCKER_CERT_PATH: /certs/client|" config.yml ;
            sed -i -e "s|^  options:|  options: -v /certs/client:/certs/client -v /etc/ssl/certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro -v /etc/ssl/certs/ca-certificates.crt:/etc/pki/tls/certs/ca-bundle.crt:ro|" config.yml ;
            sed -i -e "s|  valid_volumes: \[\]$$|  valid_volumes:\n    - /certs/client\n    - /etc/ssl/certs/ca-certificates.crt\n    - /etc/pki/tls/certs/ca-bundle.crt|" config.yml ;
              chown -R 1000:1000 /data
            '
          networks:
            - forgejo-internal

        runner-daemon:
          image: code.forgejo.org/forgejo/runner:12.5.2
          links:
            - docker-in-docker
            - forgejo
          restart: unless-stopped
          environment:
            DOCKER_HOST: tcp://docker:2376
            DOCKER_CERT_PATH: /certs/client
            DOCKER_TLS_VERIFY: "1"
          volumes:
            - /docker/forgejo/runner-data:/data
            - /etc/ssl/certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
            - docker_certs:/certs
          command: >-
            bash -c '
            while : ; do test -w .runner && forgejo-runner --config config.yml daemon ; sleep 1 ; done
            '
          networks:
            - forgejo-internal

- name: "Generate Forgejo Runner Docker Compose file"
  include_role:
    name: utils
    tasks_from: install_docker_compose_raw.yml
  vars:
    container_name: forgejo
    host: eagle
    docker_compose_content: |
      networks:
        proxy:
          external: true
        forgejo-internal:
          external: false

      volumes:
        docker_certs:

      services:
        docker-in-docker:
          image: code.forgejo.org/oci/docker:dind
          hostname: docker
          privileged: true
          environment:
            DOCKER_TLS_CERTDIR: /certs
            DOCKER_HOST: docker-in-docker
          restart: unless-stopped
          volumes:
            - docker_certs:/certs
            - /etc/ssl/certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
          networks:
            - forgejo-internal

        runner-register:
          image: code.forgejo.org/forgejo/runner:12.5.2
          links:
            - docker-in-docker
          environment:
            DOCKER_HOST: tcp://docker-in-docker:2376
          volumes:
            - /docker/forgejo/runner-data:/data
          user: 0:0
          command: >-
            bash -ec '
            while : ; do
              echo "runner: " > temp.yaml
              echo "  insecure: true" >> temp.yaml
              forgejo-runner create-runner-file --connect --instance https://{{ forgejo_domain }} --name eagle-runner --secret {{ forgejo_shared_secret2 }} --config temp.yaml && break ;
              sleep 1 ;
            done ;
            sed -i -e "s|\"labels\": null|\"labels\": [\"arm64:docker://code.forgejo.org/oci/node:20-bookworm\"]|" .runner ;
            forgejo-runner generate-config > config.yml ;
            sed -i -e "s|  insecure: false|  insecure: true|" config.yml ;
            sed -i -e "s|  level: info|  level: debug|" config.yml ;
            sed -i -e "s|network: .*|network: host|" config.yml ;
            sed -i -e "s|^  envs:$$|  envs:\n    DOCKER_HOST: tcp://docker:2376\n    DOCKER_TLS_VERIFY: 1\n    DOCKER_CERT_PATH: /certs/client|" config.yml ;
            sed -i -e "s|^  options:|  options: -v /certs/client:/certs/client -v /etc/ssl/certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro -v /etc/ssl/certs/ca-certificates.crt:/etc/pki/tls/certs/ca-bundle.crt:ro|" config.yml ;
            sed -i -e "s|  valid_volumes: \[\]$$|  valid_volumes:\n    - /certs/client\n    - /etc/ssl/certs/ca-certificates.crt\n    - /etc/pki/tls/certs/ca-bundle.crt|" config.yml ;
            chown -R 1000:1000 /data
            '
          networks:
            - forgejo-internal

        runner-daemon:
          image: code.forgejo.org/forgejo/runner:12.5.2
          links:
            - docker-in-docker
          restart: unless-stopped
          environment:
            DOCKER_HOST: tcp://docker:2376
            DOCKER_CERT_PATH: /certs/client
            DOCKER_TLS_VERIFY: "1"
          volumes:
            - /docker/forgejo/runner-data:/data
            - docker_certs:/certs
            - /etc/ssl/certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
          command: >-
            bash -c '
            while : ; do test -w .runner && forgejo-runner --config config.yml daemon ; sleep 1 ; done
            '
          networks:
            - forgejo-internal
